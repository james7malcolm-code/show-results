name: AI Vulnerability Analysis

on:
  workflow_run:
    workflows: ["OWASP ZAP Full Scan"]  # UPDATE to match your real workflow names
    types:
      - completed

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: results/

      - name: Install python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: pip install openai==1.16.0

      - name: Run AI analysis
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python3 <<EOF
import os
import glob
from openai import OpenAI

client = OpenAI()

def load_any(pattern):
    files = glob.glob(pattern)
    if files:
        return open(files[0], "r", encoding="utf-8").read()
    return "FILE NOT FOUND"

sarif = load_any("results/**/*.sarif")
zap_html = load_any("results/**/zap-report.html")

prompt = f"""
Analyze these security scan results.

--- CODEQL (SARIF) ---
{sarif}

--- OWASP ZAP (HTML Report) ---
{zap_html}

Explain clearly:
1. All vulnerabilities found
2. Severity ranking (Critical â†’ Low)
3. Likely impact
4. False positives or uncertain findings
5. How to fix each one safely
6. Any patterns suggesting deeper issues
"""

response = client.chat.completions.create(
    model="gpt-4.1-mini",
    messages=[{"role": "user", "content": prompt}]
)

analysis = response.choices[0].message["content"]

with open("analysis.txt", "w") as f:
    f.write(analysis)

print(analysis)
EOF

      - name: Upload AI analysis
        uses: actions/upload-artifact@v4
        with:
          name: ai-analysis
          path: analysis.txt
